name: Auto Sync To External Branch
# Controls when the action will run. Workflow runs when manually triggered using the UI
# or API.
on:
  push:
    branches:
      - main

jobs:
  sync-repo:
    runs-on: self-hosted

    steps:
      - name: Checkout source repository
        uses: actions/checkout@v2
        with:
          ref: main

      - name: Set up Git credential
        run: |
          git config --global user.name 'gooishin'
          git config --global user.email 'shing.shan.gooi@intel.com'

      - name: Add destination repository as a remote
        run: |
          if ! git remote | grep destination; then
            remote_url="https://${{ secrets.DESTINATION_REPO_PAT }}@github.com/gooishin/Test_Destination_repo.git"
            git remote add destination "$remote_url"
          fi
          git remote -v
          
      - name: Fetch destination repository
        run:  |
          git fetch destination || (echo "Fetch failed" && git remote -v && exit 1)

      - name: Exclude .github sync to external
        run: |
         cd /home/user/actions-runner/_work/Test_source_repo/Test_source_repo
         echo ".github/" >> .gitignore
         git add .gitignore
         git commit -m "ignore .github" .gitignore

      - name: Create branch at destination repo
        run: |
          cd /home/user/actions-runner/_work/
          git clone https://github.com/gooishin/Test_Destination_repo.git
          cd Test_Destination_repo
          git checkout -b update-branch
      
      - name: Push to destination repository
        run: |
          cd /home/user/actions-runner/_work/Test_source_repo/Test_source_repo
          git push destination main:update-branch --force

      - name: Create pull request
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.DESTINATION_REPO_PAT }}
          script: |
            const { data: pullRequests } = await github.pulls.list({
              owner: 'gooishin',
              repo: 'Test_Destination_repo',
              state: 'open',
              head: 'gooishin:update-main',
              base: 'main'
            });
          
            if (pullRequests.length === 0) {
              await github.pulls.create({
                owner: 'gooishin',
                repo: 'Test_Destination_repo',
                title: 'Sync main branch from source repo',
                head: 'update-main',
                base: 'main',
                body: 'This PR syncs the main branch from the source repository to the destination repository.'
              });
            } else {
              console.log('A pull request already exists:', pullRequests[0].html_url);
            }
