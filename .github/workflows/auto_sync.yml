# This is a basic workflow that is manually triggered

name: Auto Sync To External Branch

# Controls when the action will run. Workflow runs when manually triggered using the UI
# or API.
on:
  push:
    branches:
      - main

jobs:
  sync-repo:
    runs-on: self-hosted
    permissions:
      contents: write

    steps:
      - name: Checkout source repository
        uses: actions/checkout@v2
        with:
          ref: main

      - name: Set up Git credential
        run: |
          git config --global user.name 'gooishin'
          git config --global user.email 'shing.shan.gooi@intel.com'

      - name: Add destination repository as a remote
        run: |
          if ! git remote | grep destination; then
            remote_url="https://github.com/gooishin/Test_Destination_repo.git"
            git remote add destination "$remote_url"
          fi
          git remote -v
          
      - name: Fetch destination repository
        run:  |
          git fetch destination || (echo "Fetch failed" && git remote -v && exit 1)

      - name: Create sync branch
        run: |
          git checkout -b update-main
          git reset --hard origin/main

      - name: Exclude .github sync to external
        run: |
          rsync -avz --exclude='.github' . ../update-main
          cd ../update-main
          git init
          if ! git remote | grep destination; then
            remote_url="https://github.com/gooishin/Test_Destination_repo.git"
            git remote add destination "$remote_url"
          fi
          git checkout update-main
          git add .
          git commit -m "Sync main branch from source repo"
          
      - name: Push sync branch to destination repository
        uses: ad-m/github-push-action@v0.6.0
        with:
          github_token: ${{ secrets.DESTINATION_REPO_PAT }}
          repository: gooishin/Test_Destination_repo
          branch: sync-main
          force: true

      - name: Create pull request
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.DESTINATION_REPO_PAT }}
          script: |
            const { data: pullRequests } = await github.pulls.list({
              owner: 'gooishin',
              repo: 'Test_Destination_repo',
              state: 'open',
              head: 'gooishin:sync-main',
              base: 'main'
            });
          
            if (pullRequests.length === 0) {
              await github.pulls.create({
                owner: 'gooishin',
                repo: 'Test_Destination_repo',
                title: 'Sync main branch from source repo',
                head: 'sync-main',
                base: 'main',
                body: 'This PR syncs the main branch from the source repository to the destination repository.'
              });
            } else {
              console.log('A pull request already exists:', pullRequests[0].html_url);
            }
